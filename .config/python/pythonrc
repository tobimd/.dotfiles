import atexit
import code
import os
import readline

class HistoryConsole(code.InteractiveConsole):
    def __init__(self, locals=None, filename="<console>",
                 histfile=os.path.expanduser("~/.hsts/python-hst")):
        code.InteractiveConsole.__init__(self, locals, filename)
        self.init_history(histfile)

    def init_history(self, histfile):
        readline.parse_and_bind("tab: complete")
        if hasattr(readline, "read_history_file"):
            try:
                readline.read_history_file(histfile)
                self.h_len = readline.get_current_history_length()
            except FileNotFoundError:
                open(histfile, 'wb').close()
                self.h_len = 0
            atexit.register(self.save_history, histfile)

    def save_history(self, histfile):
        new_h_len = readline.get_current_history_length()
        
        readline.set_history_length(1000)
        readline.append_history_file(new_h_len - self.h_len, histfile)